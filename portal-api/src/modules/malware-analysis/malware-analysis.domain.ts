import { streamToBlob } from '../../utils/processUploadFile';
import config from 'config';
const GLIMPS_URL = config.get('malware_analysis.url');
export const analyseString = async ({
  string,
  uploadFile,
}: {
  string?: string;
  uploadFile?: {
    file: {
      createReadStream: () => NodeJS.ReadableStream;
      filename: string;
      mimeType: string;
    };
  };
}) => {
  if (uploadFile.file) {
    const blob = await streamToBlob(
      uploadFile.file.createReadStream(),
      uploadFile.file.mimeType
    );
    const formData = new FormData();
    formData.append('file', blob, uploadFile.file.filename);
    return await fetch(`${GLIMPS_URL}/analyses/submit`, {
      method: 'POST',
      headers: {
        Accept: 'application/json',
      },
      body: formData,
    }).then((response) => response.json());
  }

  return await fetch(`${GLIMPS_URL}/analyses/submit`, {
    method: 'POST',
    headers: {
      Accept: 'application/json',
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ string }),
  }).then((response) => response.json());
};
