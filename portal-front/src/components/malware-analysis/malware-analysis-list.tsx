import {
  graphql,
  PreloadedQuery,
  usePreloadedQuery,
  useRefetchableFragment,
  useSubscription,
} from 'react-relay';
import { FunctionComponent, useMemo, useState } from 'react';
import { pageLoaderMalwareAnalysisQuery } from '../../../__generated__/pageLoaderMalwareAnalysisQuery.graphql';
import { MalwareAnalysisQuery } from '../../../app/(application)/(user)/service/malware-analysis/page-loader';
import { malwareAnalysisList_malwareAnalysis$key } from '../../../__generated__/malwareAnalysisList_malwareAnalysis.graphql';
import { ColumnDef, PaginationState } from '@tanstack/react-table';
import { malwareAnalysis_fragment$data } from '../../../__generated__/malwareAnalysis_fragment.graphql';
import * as React from 'react';
import { DataTable } from 'filigran-ui/clients';
import { FormatDate } from '@/utils/date';
import { Button } from 'filigran-ui/servers';
import { MalwareAnalysisResultSheet } from '@/components/malware-analysis/malware-analysis-result-sheet';
import { MalwareAnalysisForm } from '@/components/malware-analysis/malware-analysis-form';

export const subscription = graphql`
  subscription malwareAnalysisListSubscription($connections: [ID!]!) {
    MalwareAnalysis {
      add
        @prependNode(
          connections: $connections
          edgeTypeName: "MalwareAnalysisEdge"
        ) {
        ...malwareAnalysis_fragment
      }
      edit {
        ...malwareAnalysis_fragment
      }
      delete {
        id @deleteRecord
      }
    }
  }
`;
export const malwareAnalysisFragment = graphql`
  fragment malwareAnalysisList_malwareAnalysis on Query
  @refetchable(queryName: "MalwareAnalysisPaginationQuery") {
    malwareAnalysis(
      first: $count
      after: $cursor
      orderBy: $orderBy
      orderMode: $orderMode
    ) {
      __id
      totalCount
      edges {
        node {
          id
          ...malwareAnalysis_fragment @relay(mask: false)
        }
      }
    }
  }
`;

export const malwareAnalysisColumns: ColumnDef<malwareAnalysis_fragment$data>[] =
  [
    {
      id: 'name',
      accessorKey: 'name',
      header: 'Name',
    },
    {
      id: 'type',
      accessorKey: 'type',
      header: 'Type',
    },
    {
      id: 'created_at',
      accessorKey: 'created_at',
      header: 'Created At',
      cell: (info) => <>{FormatDate(info.getValue() as string)}</>,
    },
    {
      id: 'ended_at',
      accessorKey: 'ended_at',
      header: 'Ended At',
      cell: (info) => <>{FormatDate(info.getValue() as string)}</>,
    },
    {
      id: 'status',
      accessorKey: 'status',
      header: 'Status',
    },
    {
      id: 'details',
      cell: ({ row }) => {
        return row.original.status.toUpperCase() === 'DONE' ? (
          <MalwareAnalysisResultSheet
            result={row.original.result}
            name={row.original.name}
          />
        ) : null;
      },
      enableHiding: false,
      enableSorting: false,
      enableResizing: false,
    },
  ];
interface MalwareAnalysisListProps {
  queryRef: PreloadedQuery<pageLoaderMalwareAnalysisQuery>;
}
export const MalwareAnalysisList: FunctionComponent<
  MalwareAnalysisListProps
> = ({ queryRef }) => {
  const queryData = usePreloadedQuery<pageLoaderMalwareAnalysisQuery>(
    MalwareAnalysisQuery,
    queryRef
  );
  const [pagination, setPagination] = useState<PaginationState>({
    pageIndex: 0,
    pageSize: 50,
  });
  const [data, refetch] = useRefetchableFragment<
    pageLoaderMalwareAnalysisQuery,
    malwareAnalysisList_malwareAnalysis$key
  >(malwareAnalysisFragment, queryData);
  const connectionID = data?.malwareAnalysis?.__id;

  const config = useMemo(
    () => ({
      variables: { connections: [connectionID] },
      subscription,
    }),
    [connectionID]
  );

  useSubscription(config);
  const columnData = data.malwareAnalysis.edges.map(
    ({ node }) => node as malwareAnalysis_fragment$data
  );
  return (
    <div>
      <DataTable
        columns={malwareAnalysisColumns}
        data={columnData}
        tableOptions={{
          onPaginationChange: setPagination,
        }}
        tableState={{ pagination }}
      />
    </div>
  );
};
